<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Theo dõi tiết kiệm điện mặt trời">
    <meta name="theme-color" content="#2563eb">
    <title>Solar Saver</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        #root { min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // Icon components (inline SVG)
        const HomeIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
        );

        const HistoryIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );

        const SettingsIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6m-9-9h6m6 0h6m-16.97 1.76l4.24 4.24m6.36 0l4.24-4.24m-4.24-6.36l4.24 4.24m-13.6 0l4.24-4.24"/>
            </svg>
        );

        const TrashIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
        );

        const DownloadIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        );

        const UploadIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        );

        // Biểu giá điện sinh hoạt
        const DEFAULT_ELECTRIC_PRICE = [
            { bac: 1, from: 0, to: 50, price: 1984 },
            { bac: 2, from: 51, to: 100, price: 2050 },
            { bac: 3, from: 101, to: 200, price: 2380 },
            { bac: 4, from: 201, to: 300, price: 2998 },
            { bac: 5, from: 301, to: 400, price: 3350 },
            { bac: 6, from: 401, to: 999999, price: 3460 }
        ];

        const TAX_RATE = 0.08;

        function App() {
            const [activeTab, setActiveTab] = useState('home');
            const [contracts, setContracts] = useState(() => {
                const saved = localStorage.getItem('contracts');
                return saved ? parseInt(saved) : 2;
            });
            const [electricPrice, setElectricPrice] = useState(() => {
                const saved = localStorage.getItem('electricPrice');
                return saved ? JSON.parse(saved) : DEFAULT_ELECTRIC_PRICE;
            });
            const [priceUpdateDate, setPriceUpdateDate] = useState(() => {
                return localStorage.getItem('priceUpdateDate') || '2025-01-01';
            });
            const [investment, setInvestment] = useState(() => {
                const saved = localStorage.getItem('investment');
                return saved ? JSON.parse(saved) : { capacity: 8610, power: 14.3, cost: 140000000 };
            });
            const [currentMonth, setCurrentMonth] = useState({
                month: new Date().toISOString().slice(0, 7),
                evn: 0,
                solar: 0
            });
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('history');
                return saved ? JSON.parse(saved) : [];
            });
            const [maintenance, setMaintenance] = useState(() => {
                const saved = localStorage.getItem('maintenance');
                return saved ? JSON.parse(saved) : [];
            });
            const [newMaintenance, setNewMaintenance] = useState({
                date: new Date().toISOString().slice(0, 10),
                description: '',
                cost: 0
            });

            // Save to localStorage when data changes
            React.useEffect(() => {
                localStorage.setItem('contracts', contracts);
            }, [contracts]);

            React.useEffect(() => {
                localStorage.setItem('electricPrice', JSON.stringify(electricPrice));
            }, [electricPrice]);

            React.useEffect(() => {
                localStorage.setItem('priceUpdateDate', priceUpdateDate);
            }, [priceUpdateDate]);

            React.useEffect(() => {
                localStorage.setItem('investment', JSON.stringify(investment));
            }, [investment]);

            React.useEffect(() => {
                localStorage.setItem('history', JSON.stringify(history));
            }, [history]);

            React.useEffect(() => {
                localStorage.setItem('maintenance', JSON.stringify(maintenance));
            }, [maintenance]);

            const calculateElectricCost = (kwh) => {
                let totalCostBeforeTax = 0;
                let remaining = kwh;
                
                for (let tier of electricPrice) {
                    if (remaining <= 0) break;
                    
                    let tierKwh;
                    if (tier.from === 0) {
                        tierKwh = tier.to;
                    } else {
                        tierKwh = tier.to - tier.from + 1;
                    }
                    
                    const tierCapacity = tierKwh * contracts;
                    const usage = Math.min(remaining, tierCapacity);
                    
                    totalCostBeforeTax += usage * tier.price;
                    remaining -= usage;
                }
                
                const totalCostWithTax = totalCostBeforeTax * (1 + TAX_RATE);
                return Math.round(totalCostWithTax);
            };

            const calculateSavings = () => {
                const totalUsage = currentMonth.evn + currentMonth.solar;
                const withoutSolar = calculateElectricCost(totalUsage);
                const actualCost = calculateElectricCost(currentMonth.evn);
                const monthlySavings = withoutSolar - actualCost;
                
                const totalSavings = history.reduce((sum, record) => sum + record.savings, 0);
                const totalMaintenance = maintenance.reduce((sum, record) => sum + record.cost, 0);
                const netSavings = totalSavings - totalMaintenance;
                const recoveryPercent = (netSavings / investment.cost) * 100;
                
                const avgMonthlySavings = history.length > 0 
                    ? history.reduce((sum, record) => sum + record.savings, 0) / history.length 
                    : monthlySavings;
                const remainingInvestment = investment.cost - netSavings;
                const monthsToRecover = avgMonthlySavings > 0 
                    ? Math.ceil(remainingInvestment / avgMonthlySavings) 
                    : 0;
                
                return {
                    totalUsage,
                    withoutSolar,
                    actualCost,
                    monthlySavings,
                    totalSavings,
                    totalMaintenance,
                    netSavings,
                    recoveryPercent,
                    monthsToRecover
                };
            };

            const savings = calculateSavings();

            const handleSaveMonth = () => {
                const [year, month] = currentMonth.month.split('-');
                const formattedMonth = `Tháng ${month}-${year}`;
                
                const newRecord = {
                    month: formattedMonth,
                    evn: currentMonth.evn,
                    solar: currentMonth.solar,
                    cost: savings.actualCost,
                    savings: savings.monthlySavings
                };
                
                setHistory([...history, newRecord]);
            };

            const handleDeleteRecord = (index) => {
                const newHistory = history.filter((item, i) => i !== index);
                setHistory(newHistory);
            };

            const handleUpdatePrice = (index, field, value) => {
                const newPrices = [...electricPrice];
                newPrices[index][field] = parseInt(value) || 0;
                setElectricPrice(newPrices);
            };

            const handleResetPrice = () => {
                setElectricPrice(DEFAULT_ELECTRIC_PRICE);
                setPriceUpdateDate(new Date().toISOString().slice(0, 10));
            };

            const handleAddMaintenance = () => {
                if (!newMaintenance.description.trim() || newMaintenance.cost <= 0) {
                    return;
                }
                
                const record = {
                    date: newMaintenance.date,
                    description: newMaintenance.description,
                    cost: parseInt(newMaintenance.cost)
                };
                
                setMaintenance([...maintenance, record]);
                setNewMaintenance({
                    date: new Date().toISOString().slice(0, 10),
                    description: '',
                    cost: 0
                });
            };

            const handleDeleteMaintenance = (index) => {
                const newMaintenance = maintenance.filter((item, i) => i !== index);
                setMaintenance(newMaintenance);
            };

            const handleExportData = () => {
                const data = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    contracts,
                    electricPrice,
                    priceUpdateDate,
                    investment,
                    history,
                    maintenance
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `solar-saver-backup-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const handleImportData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.contracts) setContracts(data.contracts);
                        if (data.electricPrice) setElectricPrice(data.electricPrice);
                        if (data.priceUpdateDate) setPriceUpdateDate(data.priceUpdateDate);
                        if (data.investment) setInvestment(data.investment);
                        if (data.history) setHistory(data.history);
                        if (data.maintenance) setMaintenance(data.maintenance);
                    } catch (error) {
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50">
                    <div className="bg-gradient-to-r from-blue-600 to-green-600 text-white p-6 shadow-lg">
                        <h1 className="text-3xl font-bold flex items-center gap-2">
                            ☀️ Solar Saver
                        </h1>
                        <p className="text-blue-100 mt-1">Theo dõi tiết kiệm điện mặt trời</p>
                    </div>

                    <div className="max-w-6xl mx-auto p-4">
                        {activeTab === 'home' && (
                            <div className="space-y-6">
                                {/* Content tương tự như artifact trước */}
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Nhập liệu tháng</h2>
                                    <div className="grid md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Tháng</label>
                                            <input
                                                type="month"
                                                value={currentMonth.month}
                                                onChange={(e) => setCurrentMonth({...currentMonth, month: e.target.value})}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Điện lưới (kWh)</label>
                                            <input
                                                type="number"
                                                value={currentMonth.evn}
                                                onChange={(e) => setCurrentMonth({...currentMonth, evn: parseInt(e.target.value) || 0})}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Solar (kWh)</label>
                                            <input
                                                type="number"
                                                value={currentMonth.solar}
                                                onChange={(e) => setCurrentMonth({...currentMonth, solar: parseInt(e.target.value) || 0})}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Summary cards và các phần khác... */}
                                <button
                                    onClick={handleSaveMonth}
                                    className="w-full bg-gradient-to-r from-blue-600 to-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg"
                                >
                                    💾 Lưu dữ liệu tháng
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Bottom Navigation */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
                        <div className="max-w-6xl mx-auto flex justify-around">
                            <button
                                onClick={() => setActiveTab('home')}
                                className={`flex-1 py-4 flex flex-col items-center gap-1 ${
                                    activeTab === 'home' ? 'text-blue-600 bg-blue-50' : 'text-gray-600'
                                }`}
                            >
                                <HomeIcon />
                                <span className="text-xs font-medium">Trang chủ</span>
                            </button>
                            
                            <button
                                onClick={() => setActiveTab('history')}
                                className={`flex-1 py-4 flex flex-col items-center gap-1 ${
                                    activeTab === 'history' ? 'text-blue-600 bg-blue-50' : 'text-gray-600'
                                }`}
                            >
                                <HistoryIcon />
                                <span className="text-xs font-medium">Lịch sử</span>
                            </button>
                            
                            <button
                                onClick={() => setActiveTab('settings')}
                                className={`flex-1 py-4 flex flex-col items-center gap-1 ${
                                    activeTab === 'settings' ? 'text-blue-600 bg-blue-50' : 'text-gray-600'
                                }`}
                            >
                                <SettingsIcon />
                                <span className="text-xs font-medium">Cài đặt</span>
                            </button>
                        </div>
                    </div>

                    <div className="h-20"></div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>