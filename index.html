<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Saver - Bảng Điều Khiển</title>
    
    <!-- Cấu hình PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    
    <!-- TẢI TẤT CẢ THƯ VIỆN BÊN NGOÀI TRƯỚC KHI TẢI CODE REACT -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
        }
        #root {
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Khối script type="text/babel" chứa code React -->
    <script type="text/babel"> 
        const { useState, useEffect } = React;
        
        // Dữ liệu giả định cho biểu đồ năng lượng mặt trời
        const data = [
          { name: 'T1', "Sản xuất (kWh)": 650, "Tiết kiệm (VND)": 1500000, "CO2 giảm (kg)": 455 },
          { name: 'T2', "Sản xuất (kWh)": 720, "Tiết kiệm (VND)": 1750000, "CO2 giảm (kg)": 504 },
          { name: 'T3', "Sản xuất (kWh)": 810, "Tiết kiệm (VND)": 1900000, "CO2 giảm (kg)": 567 },
          { name: 'T4', "Sản xuất (kWh)": 950, "Tiết kiệm (VND)": 2200000, "CO2 giảm (kg)": 665 },
          { name: 'T5', "Sản xuất (kWh)": 1020, "Tiết kiệm (VND)": 2450000, "CO2 giảm (kg)": 714 },
          { name: 'T6', "Sản xuất (kWh)": 980, "Tiết kiệm (VND)": 2300000, "CO2 giảm (kg)": 686 },
        ];

        // Component Icon (Thay thế bằng biểu tượng Năng lượng mặt trời)
        const SolarIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={props.className || "w-6 h-6"} aria-hidden="true">
                <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.575 17.567a.75.75 0 01-1.06-1.06L7.566 16.5l.009.009.008.007 1.077 1.077zM20.25 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM12 21.75a.75.75 0 01-.75-.75v-2.25a.75.75 0 011.5 0v2.25a.75.75 0 01-.75.75zM3.75 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H4.5a.75.75 0 01-.75-.75zM17.567 16.425a.75.75 0 01-1.06 1.06l-.007-.008-.009-.008-1.077-1.077 1.06-1.06a.75.75 0 011.084 1.045l-.018.018zM6.417 5.175l1.06 1.06a.75.75 0 01-1.06 1.06L6.408 6.239l-1.06-1.06a.75.75 0 011.06-1.06zM18.783 6.239l-1.06 1.06a.75.75 0 01-1.06-1.06l1.06-1.06a.75.75 0 011.06 1.06zM12 8.25a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5z" />
            </svg>
        );

        // Component Thẻ (Card Component)
        const Card = ({ title, value, unit, icon }) => (
            <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex items-center justify-between transition duration-300 hover:shadow-xl">
                <div>
                    <p className="text-sm font-medium text-gray-500">{title}</p>
                    <p className="text-3xl font-extrabold text-gray-900 mt-1">{value} <span className="text-base font-normal text-gray-500">{unit}</span></p>
                </div>
                <div className="p-3 rounded-full bg-yellow-100">
                    {React.cloneElement(icon, { className: "w-6 h-6 text-yellow-600" })}
                </div>
            </div>
        );

        const App = () => {
          const [loading, setLoading] = useState(true);
          const [rechartsComponents, setRechartsComponents] = useState({});
          
          // Sử dụng useEffect để kiểm tra sự sẵn sàng của thư viện một cách an toàn
          useEffect(() => {
            const checkRecharts = () => {
                if (window.Recharts && window.Recharts.LineChart) {
                    setRechartsComponents({
                        LineChart: window.Recharts.LineChart,
                        Line: window.Recharts.Line,
                        XAxis: window.Recharts.XAxis,
                        YAxis: window.Recharts.YAxis,
                        CartesianGrid: window.Recharts.CartesianGrid,
                        Tooltip: window.Recharts.Tooltip,
                        Legend: window.Recharts.Legend,
                        ResponsiveContainer: window.Recharts.ResponsiveContainer,
                    });
                    setLoading(false);
                } else {
                    const timer = setTimeout(checkRecharts, 200);
                    return () => clearTimeout(timer);
                }
            };
            checkRecharts();
          }, []);

          // Destructure các component đã được kiểm tra tính sẵn sàng
          const { 
              LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer 
          } = rechartsComponents;


          if (loading) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <div className="text-xl font-semibold text-gray-600">Đang tải bảng điều khiển Solar Saver...</div>
              </div>
            );
          }

          const isChartReady = LineChart && ResponsiveContainer; 

          return (
            <div className="p-4 sm:p-8 bg-gray-50 min-h-screen font-sans">
              <div className="max-w-7xl mx-auto">
                
                {/* Tiêu đề */}
                <header className="flex items-center justify-between border-b pb-4 mb-6">
                  <h1 className="text-3xl font-extrabold text-gray-900 flex items-center">
                    <SolarIcon className="w-8 h-8 mr-2 text-yellow-600" />
                    Bảng Điều Khiển Năng Lượng Mặt Trời
                  </h1>
                  <button className="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                    Xem Dữ Liệu Chi Tiết
                  </button>
                </header>

                {/* Thẻ số liệu */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  {/* Tổng Năng lượng đã sản xuất (kWh) */}
                  <Card 
                    title="Tổng Năng Lượng Sản Xuất" 
                    value="5,130" 
                    unit="kWh" 
                    icon={<SolarIcon />} 
                  />
                  {/* Tổng Tiết kiệm được (VND) */}
                  <Card 
                    title="Tổng Chi Phí Tiết Kiệm" 
                    value="12,150,000" 
                    unit="VND" 
                    icon={<SolarIcon />} 
                  />
                  {/* Tổng CO2 giảm thiểu (kg) */}
                  <Card 
                    title="Tổng CO2 Giảm Thiểu" 
                    value="3,591" 
                    unit="kg" 
                    icon={<SolarIcon />} 
                  />
                </div>

                {/* Khu vực biểu đồ */}
                <div className="bg-white p-6 rounded-xl shadow-lg">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Hiệu Suất Năng Lượng 6 Tháng</h2>
                  <div className="w-full h-80">
                    {!isChartReady ? (
                        <div className="flex items-center justify-center h-full text-gray-500">
                            Đang chờ tải thư viện biểu đồ...
                        </div>
                    ) : (
                        <ResponsiveContainer width="100%" height="100%">
                          <LineChart data={data} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                            <XAxis dataKey="name" stroke="#333" />
                            <YAxis 
                                yAxisId="left" 
                                stroke="#8884d8" 
                                tickFormatter={(value) => `${value} kWh`}
                                domain={[600, 1100]}
                            />
                             <YAxis 
                                yAxisId="right" 
                                orientation="right" 
                                stroke="#82ca9d" 
                                tickFormatter={(value) => `${(value/1000000).toFixed(1)} Tr`}
                            />
                            <Tooltip 
                              contentStyle={{ backgroundColor: '#fff', border: '1px solid #ccc', borderRadius: '8px', padding: '10px' }}
                              labelStyle={{ fontWeight: 'bold' }}
                              formatter={(value, name, props) => [`${value} ${props.dataKey.split(' ')[1] || ''}`, name]}
                            />
                            <Legend wrapperStyle={{ paddingTop: '10px' }} />
                            {/* Đường Năng lượng Sản xuất (kWh) */}
                            <Line 
                                yAxisId="left" 
                                type="monotone" 
                                dataKey="Sản xuất (kWh)" 
                                stroke="#8884d8" 
                                strokeWidth={2} 
                                activeDot={{ r: 8 }} 
                            />
                            {/* Đường Tiết kiệm (VND) */}
                            <Line 
                                yAxisId="right"
                                type="monotone" 
                                dataKey="Tiết kiệm (VND)" 
                                stroke="#82ca9d" 
                                strokeWidth={2} 
                            />
                          </LineChart>
                        </ResponsiveContainer>
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

        // --- Đăng ký Service Worker ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            // Sửa lỗi: Sử dụng đường dẫn tuyệt đối cho Service Worker
            navigator.serviceWorker.register('/service-worker.js')
              .then(registration => {
                console.log('Service Worker đã đăng ký thành công:', registration.scope);
              })
              .catch(error => {
                console.error('Đăng ký Service Worker thất bại:', error);
              });
          });
        }
    </script>
</body>
</html>
